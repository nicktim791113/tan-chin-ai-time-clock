<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœ‡æ¬£AIæ‰“å¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .magic-container { background: linear-gradient(145deg, #ffffff, #e6e9ee); box-shadow: 10px 10px 20px #c8cacc, -10px -10px 20px #ffffff; }
        .btn-magic { transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-magic:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .btn-magic:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .input-magic:focus { border-color: #4a90e2; box-shadow: 0 0 10px rgba(74, 144, 226, 0.3); }
        .message-box { transition: all 0.5s ease-in-out; opacity: 0; transform: translateY(-20px); }
        .message-box.show { opacity: 1; transform: translateY(0); }
        .collapsible-panel { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        #sound-manager-modal { z-index: 1050; }
        #change-password-modal { z-index: 1060; }
        #confirm-generic-modal { z-index: 1100; }
        
        @keyframes shake-error {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-error { animation: shake-error 0.5s ease-in-out; border-color: #f56565 !important; }
        @keyframes flash-success { 50% { border-color: #48bb78; box-shadow: 0 0 10px rgba(72, 187, 120, 0.5); } }
        .flash-success { animation: flash-success 0.7s ease-in-out; }
        .bell-toast {
            position: fixed; bottom: 20px; right: 20px; background-color: #6d28d9; color: white;
            padding: 1rem 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 2000; opacity: 0; transform: translateY(20px); transition: all 0.4s ease-in-out;
        }
        .bell-toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="magic-container w-full max-w-5xl p-6 sm:p-8 rounded-2xl">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">éœ‡æ¬£AIæ‰“å¡ç³»çµ±</h1>
            <div class="bg-gray-800 text-white rounded-lg p-4 mt-4 text-center shadow-inner">
                <p id="current-date" class="text-lg"></p>
                <p id="current-time" class="text-5xl font-mono font-bold tracking-wider"></p>
            </div>
        </header>

        <!-- æ‰“å¡å€ -->
        <div id="punch-area" class="mb-4">
            <label for="punch-input" class="block text-sm font-medium text-gray-700 mb-2">æ„Ÿæ‡‰æˆ–è¼¸å…¥å¡è™Ÿ</label>
            <input type="password" id="punch-input" class="input-magic w-full p-4 text-2xl text-center border border-gray-300 rounded-lg focus:outline-none" placeholder="...å¡è™Ÿè¼¸å…¥å€...">
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="shift-selector" class="block text-sm font-medium text-gray-700 mb-2">ç•¶å‰ç­åˆ¥</label>
                <select id="shift-selector" class="input-magic w-full p-3 text-lg border border-gray-300 rounded-lg"></select>
            </div>
            <div>
                <label for="punch-status-selector" class="block text-sm font-medium text-gray-700 mb-2">æ‰“å¡ç‹€æ…‹ (æ‰‹å‹•èª¿æ•´)</label>
                <select id="punch-status-selector" class="input-magic w-full p-3 text-lg border border-gray-300 rounded-lg">
                    <option value="auto">ç³»çµ±è‡ªå‹•åˆ¤æ–·</option>
                    <option value="in">ä¸Šç­</option>
                    <option value="out">ä¸‹ç­</option>
                </select>
            </div>
        </div>
        <div id="message-box" class="message-box min-h-[60px] p-4 mb-6 rounded-lg text-center font-semibold text-lg"></div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-6">
            <button id="toggle-panel-btn" class="btn-magic bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6">ç®¡ç†è€…é¢æ¿</button>
            <button id="toggle-report-btn" class="btn-magic bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6">è€ƒå‹¤å ±è¡¨</button>
            <button id="toggle-furnace-btn" class="btn-magic bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6">è€ƒå‹¤æª”æ¡ˆåº«</button>
        </div>

        <!-- ç®¡ç†é¢æ¿ -->
        <div id="management-panel" class="collapsible-panel">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 1. äººå“¡è³‡æ–™åå†Š -->
                <section class="bg-white/50 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">äººå“¡è³‡æ–™åå†Š</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="emp-id" class="input-magic p-2 border rounded col-span-1" placeholder="å·¥è™Ÿ*"><input type="text" id="emp-name" class="input-magic p-2 border rounded col-span-1" placeholder="å§“å*">
                        <input type="text" id="emp-gender" class="input-magic p-2 border rounded col-span-1" placeholder="æ€§åˆ¥"><input type="text" id="emp-nationality" class="input-magic p-2 border rounded col-span-1" placeholder="åœ‹ç±">
                        <input type="text" id="emp-dept" class="input-magic p-2 border rounded col-span-2" placeholder="éƒ¨é–€*">
                        <input type="text" id="emp-card" class="input-magic p-2 border rounded col-span-1" placeholder="å¡è™Ÿ*"><input type="text" id="emp-password" class="input-magic p-2 border rounded col-span-1" placeholder="æ‰“å¡å¯†ç¢¼*">
                        <button id="add-emp-btn" class="btn-magic w-full bg-blue-500 hover:bg-blue-600 text-white py-2 col-span-2">æ–°å¢/æ›´æ–°å“¡å·¥</button>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <label for="import-emp-csv" class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å…¥åå†Šæª” (CSV)</label>
                        <input type="file" id="import-emp-csv" accept=".csv" class="block text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <p class="text-xs text-gray-500 mt-1">æ ¼å¼: å·¥è™Ÿ,å§“å,æ€§åˆ¥,åœ‹ç±,éƒ¨é–€,å¡è™Ÿ,æ‰“å¡å¯†ç¢¼</p>
                    </div>
                    <div class="mt-4 border-t pt-4 text-center">
                        <button id="manage-employees-btn" class="btn-magic bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6">ç®¡ç†äººå“¡åå†Š</button>
                    </div>
                </section>

                <!-- 2. ç­åˆ¥è¨­å®š -->
                <section class="bg-white/50 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">ç­åˆ¥è¨­å®š</h2>
                    <div id="shift-settings" class="space-y-2 max-h-[450px] overflow-y-auto pr-2"></div>
                </section>
            </div>
            
            <!-- æ‰‹å‹•è£œç™»ç´€éŒ„ -->
            <section class="bg-white/50 p-4 rounded-lg shadow-md mt-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">æ‰‹å‹•è£œç™»ç´€éŒ„</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div class="lg:col-span-2">
                        <label for="manual-card" class="block text-xs font-medium text-gray-600">å¡è™Ÿ/å¯†ç¢¼</label>
                        <input type="text" id="manual-card" class="input-magic w-full p-2 border rounded mt-1">
                    </div>
                    <div>
                        <label for="manual-date" class="block text-xs font-medium text-gray-600">æ—¥æœŸ</label>
                        <input type="date" id="manual-date" class="input-magic w-full p-2 border rounded mt-1">
                    </div>
                    <div>
                        <label for="manual-time" class="block text-xs font-medium text-gray-600">æ™‚é–“</label>
                        <input type="time" id="manual-time" class="input-magic w-full p-2 border rounded mt-1">
                    </div>
                    <div>
                        <label for="manual-type" class="block text-xs font-medium text-gray-600">ç‹€æ…‹</label>
                        <select id="manual-type" class="input-magic w-full p-2 border rounded mt-1">
                            <option value="in">ä¸Šç­</option>
                            <option value="out">ä¸‹ç­</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-5">
                        <button id="manual-punch-btn" class="btn-magic w-full bg-yellow-500 hover:bg-yellow-600 text-black py-2">æ‰‹å‹•è£œç™»</button>
                    </div>
                </div>
            </section>

            <!-- ä½œæ¯éŸ¿éˆ´ -->
            <section class="bg-white/50 p-4 rounded-lg shadow-md mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-700">ä½œæ¯éŸ¿éˆ´ ğŸ””</h2>
                    <div class="flex flex-wrap gap-2">
                         <button id="bell-history-btn" class="btn-magic bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 text-sm">éŸ¿éˆ´ç´€éŒ„</button>
                         <button id="manage-sounds-btn" class="btn-magic bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 text-sm">ç®¡ç†è²éŸ³åº«</button>
                         <button id="add-bell-btn" class="btn-magic bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 text-sm">æ–°å¢éŸ¿éˆ´</button>
                    </div>
                </div>
                <div id="bell-schedule-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
            </section>
        </div>

        <!-- è€ƒå‹¤å ±è¡¨ -->
        <div id="report-panel" class="collapsible-panel">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">è€ƒå‹¤å ±è¡¨æŸ¥è©¢</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
                <input type="date" id="report-start-date" class="input-magic flex-grow w-full sm:w-auto p-2 border rounded-lg">
                <span class="text-gray-600">è‡³</span>
                <input type="date" id="report-end-date" class="input-magic flex-grow w-full sm:w-auto p-2 border rounded-lg">
                <button id="generate-report-btn" class="btn-magic w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6">ç”¢ç”Ÿå ±è¡¨</button>
                <button id="export-report-btn" class="btn-magic w-full sm:w-auto bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6">åŒ¯å‡ºç•¶å‰å ±è¡¨</button>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner">
                <div id="report-table-container" class="overflow-auto" style="max-height: 400px;">
                    <table class="min-w-full text-sm">
                        <thead id="report-table-head" class="bg-gray-200 sticky top-0"></thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">ç®¡ç†è€…å¯†ç¢¼</h3>
                <button id="change-admin-password-btn" class="text-xs text-blue-600 hover:text-blue-800">æ›´æ”¹å¯†ç¢¼</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ã€‚</p>
            <input type="password" id="admin-password-input" class="input-magic w-full p-2 border rounded" placeholder="è«‹è¼¸å…¥å¯†ç¢¼...">
            <p id="password-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-password-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-password-btn" class="btn-magic bg-purple-600 hover:bg-purple-700 text-white py-2 px-4">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="report-auth-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ‰“å¡ç´€éŒ„æŸ¥è©¢å¯†ç¢¼</h3>
            <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥æ‚¨çš„å¡è™Ÿ/å¯†ç¢¼ã€‚</p>
            <input type="password" id="report-auth-input" class="input-magic w-full p-2 border rounded" placeholder="è¼¸å…¥å¡è™Ÿ/å¯†ç¢¼...">
            <p id="report-auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-report-auth-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-report-auth-btn" class="btn-magic bg-green-600 hover:bg-green-700 text-white py-2 px-4">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="furnace-auth-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-red-800">è€ƒå‹¤è¨˜éŒ„åº«å¯†ç¢¼</h3>
                <button id="change-furnace-password-btn" class="text-xs text-blue-600 hover:text-blue-800">æ›´æ”¹å¯†ç¢¼</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ä»¥é–‹å•Ÿæª”æ¡ˆåº«ã€‚</p>
            <input type="password" id="furnace-auth-input" class="input-magic w-full p-2 border rounded" placeholder="è«‹è¼¸å…¥å¯†ç¢¼...">
            <p id="furnace-auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-furnace-auth-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-furnace-auth-btn" class="btn-magic bg-red-600 hover:bg-red-700 text-white py-2 px-4">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="furnace-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-700">æª”æ¡ˆåº«ç®¡ç†</h2>
                <button id="close-furnace-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-4 space-y-8">
                <!-- Manual Operations Section -->
                <section class="bg-white/50 p-4 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ¸…ç†èˆŠçš„æ‰“å¡ç´€éŒ„</label>
                        <p class="text-xs text-gray-500 mt-1 mb-2">æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æŒ‡å®šæ—¥æœŸï¼ˆå«ï¼‰ä¹‹å‰çš„**æ‰€æœ‰**æ‰“å¡ç´€éŒ„ï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
                        <div class="flex items-center gap-4">
                            <input type="date" id="clear-records-date" class="input-magic p-2 border rounded-lg">
                            <button id="clear-records-btn" class="btn-magic bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6">æ¸…ç†</button>
                        </div>
                    </div>
                    <div class="mt-6 border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700">åŒ¯å‡ºå®Œæ•´çš„æ‰“å¡ç´€éŒ„</label>
                        <p class="text-xs text-gray-500 mt-1 mb-2">å°‡æ‰€æœ‰æ‰“å¡ç´€éŒ„åŒ¯å‡ºæˆä¸€ä»½å®Œæ•´çš„æª”æ¡ˆ(CSV)ã€‚</p>
                        <button id="export-all-records-btn" class="btn-magic w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6">åŒ¯å‡ºæ‰€æœ‰ç´€éŒ„</button>
                    </div>
                </section>
                
                <!-- Auto Task Settings Section -->
                <section class="bg-white/50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">è‡ªå‹•ä»»å‹™è¨­å®šå€</h3>
                    <div id="auto-task-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 mb-4"></div>
                    <div class="border-t pt-4">
                         <h4 class="text-md font-semibold text-gray-600 mb-3">æ–°å¢è‡ªå‹•ä»»å‹™</h4>
                         <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3 items-end">
                             <div>
                                 <label for="task-cycle" class="block text-xs font-medium text-gray-600">é€±æœŸ</label>
                                 <select id="task-cycle" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                                     <option value="weekly">æ¯å‘¨</option>
                                     <option value="monthly">æ¯æœˆ</option>
                                 </select>
                             </div>
                             <div id="task-day-weekly-container">
                                 <label for="task-day-weekly" class="block text-xs font-medium text-gray-600">æ—¥æœŸ</label>
                                 <select id="task-day-weekly" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                                     <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option>
                                     <option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option>
                                     <option value="0">é€±æ—¥</option>
                                 </select>
                             </div>
                             <div id="task-day-monthly-container" class="hidden">
                                 <label for="task-day-monthly" class="block text-xs font-medium text-gray-600">æ—¥æœŸ (1-28è™Ÿ)</label>
                                 <input type="number" id="task-day-monthly" value="1" min="1" max="28" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                             </div>
                             <div>
                                 <label for="task-time" class="block text-xs font-medium text-gray-600">æ™‚é–“</label>
                                 <input type="time" id="task-time" value="07:00" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                             </div>
                             <div>
                                 <label for="task-name" class="block text-xs font-medium text-gray-600">ä»»å‹™</label>
                                 <select id="task-name" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                                     <option value="export">åŒ¯å‡º</option>
                                     <option value="delete">åˆªé™¤</option>
                                 </select>
                             </div>
                             <div>
                                 <label for="task-target" class="block text-xs font-medium text-gray-600">ç›®æ¨™</label>
                                 <select id="task-target" class="input-magic w-full p-2 border rounded mt-1 text-sm">
                                     <option value="last_week">ä¸Šé€±æ‰“å¡ç´€éŒ„</option>
                                     <option value="last_month">ä¸Šå€‹æœˆæ‰“å¡ç´€éŒ„</option>
                                     <option value="last_week_bell">ä¸Šé€±éŸ¿éˆ´ç´€éŒ„</option>
                                     <option value="task_log">ç³»çµ±ä»»å‹™æ—¥èªŒ</option>
                                 </select>
                             </div>
                             <div class="col-span-2 lg:col-span-3">
                                <div id="task-delete-warning" class="hidden text-center text-xs text-red-500 font-bold mb-2">
                                     è­¦å‘Š: åˆªé™¤ç‚ºæ°¸ä¹…æ€§æ“ä½œï¼Œç„¡æ³•å¾©åŸï¼
                                 </div>
                                 <button id="add-auto-task-btn" class="btn-magic w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 text-sm">æ–°å¢ä»»å‹™</button>
                             </div>
                         </div>
                    </div>
                </section>

                <!-- System Task Log Section -->
                <section class="bg-white/50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">ç³»çµ±ä»»å‹™æ—¥èªŒ</h3>
                    <div id="task-log-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 text-sm bg-gray-100 p-2 rounded"></div>
                </section>
            </div>
        </div>
    </div>

    <div id="employee-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-4xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4">äººå“¡åå†Šç®¡ç†</h3>
             <div class="max-h-96 overflow-y-auto bg-white rounded-lg shadow-inner">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0"><tr><th class="py-2 px-2 text-left">å·¥è™Ÿ</th><th class="py-2 px-2 text-left">å§“å</th><th class="py-2 px-2 text-left">éƒ¨é–€</th><th class="py-2 px-2 text-left">æ€§åˆ¥</th><th class="py-2 px-2 text-left">åœ‹ç±</th><th class="py-2 px-2 text-left">å¡è™Ÿ</th><th class="py-2 px-2 text-left">å¯†ç¢¼</th><th class="py-2 px-2 text-left">æ“ä½œ</th></tr></thead>
                    <tbody id="employee-list-body"></tbody>
                </table>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="export-employees-btn" class="btn-magic bg-green-500 hover:bg-green-600 text-white py-2 px-6">åŒ¯å‡ºäººå“¡åå†Š</button>
                <button id="close-employee-modal-btn" class="btn-magic bg-gray-500 hover:bg-gray-600 text-white py-2 px-6">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-generic-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-lg font-bold text-yellow-600 mb-4" id="confirm-generic-title">ç¢ºèªæ“ä½œ</h3>
            <p class="text-sm text-gray-600 mb-4" id="confirm-generic-message">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-generic-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-generic-btn" class="btn-magic bg-red-600 hover:bg-red-700 text-white py-2 px-4">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="bell-schedule-modal" class="modal-overlay"><div class="modal-content w-full max-w-lg"><h3 id="bell-modal-title" class="text-2xl font-bold text-gray-800 mb-6"></h3><form id="bell-schedule-form" class="space-y-4"><input type="hidden" id="bell-schedule-id" name="id"><div><label for="bell-title" class="block text-sm font-medium text-gray-700">å ´æ™¯æ¨™é¡Œ</label><input type="text" id="bell-title" name="title" class="input-magic mt-1 block w-full" placeholder="ä¾‹å¦‚ï¼šåˆèŒ¶æ™‚é–“åˆ°äº†ï¼" required></div><div><label for="bell-time" class="block text-sm font-medium text-gray-700">éŸ¿éˆ´æ™‚é–“</label><input type="time" id="bell-time" name="time" class="input-magic mt-1 block w-full" required></div><div><label class="block text-sm font-medium text-gray-700">é‡è¤‡é€±æœŸ</label><div class="mt-2 grid grid-cols-4 sm:grid-cols-7 gap-2" id="bell-days-container"><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="1" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">ä¸€</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="2" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">äºŒ</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="3" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">ä¸‰</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="4" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">å››</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="5" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">äº”</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="6" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">å…­</span></label><label class="border rounded-md py-2 px-3 flex items-center justify-center text-sm font-medium text-gray-700 cursor-pointer hover:bg-blue-50"><input type="checkbox" name="day" value="0" class="hidden peer"> <span class="peer-checked:text-blue-600 peer-checked:font-bold">æ—¥</span></label></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="bell-sound" class="block text-sm font-medium text-gray-700">é¸æ“‡éŸ³æ•ˆ</label><select id="bell-sound" name="sound" class="input-magic mt-1 block w-full"></select></div><div><label for="bell-duration" class="block text-sm font-medium text-gray-700">éŸ¿éˆ´æ™‚é•· (ç§’)</label><input type="number" id="bell-duration" name="duration" class="input-magic mt-1 block w-full" min="1" max="60" value="5"></div></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="bell-cancel-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button><button type="submit" class="btn-magic bg-blue-500 hover:bg-blue-600 text-white py-2 px-4">å„²å­˜</button></div></form></div></div>
    <div id="bell-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">éŸ¿éˆ´æ­·å²</h3>
                <div class="flex items-center gap-4">
                    <button id="clear-bell-history-btn" class="btn-magic bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                    <button id="bell-close-history-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
                </div>
            </div>
            <div id="bell-history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
        </div>
    </div>
    <div id="sound-manager-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">è²éŸ³åº«ç®¡ç†</h3>
                <button id="close-sound-manager-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-6">
                <label for="sound-upload-input" class="block text-sm font-medium text-gray-700 mb-2">æ–°å¢è²éŸ³æª” (MP3, WAV)</label>
                <input type="file" id="sound-upload-input" accept="audio/*" class="block text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <h4 class="text-lg font-semibold text-gray-700 mb-3">æˆ‘çš„æ”¶è—</h4>
            <div id="sound-manager-list" class="space-y-3 max-h-64 overflow-y-auto pr-2 bg-gray-50 p-3 rounded-lg">
                <!-- è‡ªè¨‚éŸ³æ•ˆåˆ—è¡¨æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>
    <div id="bell-toast-container"></div>
    
    <!-- æ–°å¢ï¼šå¯†ç¢¼ä¿®æ”¹å½ˆçª— -->
    <div id="change-password-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="change-password-title">æ›´æ”¹å¯†ç¢¼</h3>
            <div class="space-y-4">
                <div>
                    <label for="master-password-input" class="block text-sm font-medium text-gray-700">è¶…ç´šå¯†ç¢¼</label>
                    <input type="password" id="master-password-input" class="input-magic mt-1 block w-full" placeholder="è«‹è¼¸å…¥è¶…ç´šå¯†ç¢¼">
                </div>
                <div>
                    <label for="new-password-input" class="block text-sm font-medium text-gray-700">æ–°å¯†ç¢¼</label>
                    <input type="password" id="new-password-input" class="input-magic mt-1 block w-full" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
                <div>
                    <label for="confirm-password-input" class="block text-sm font-medium text-gray-700">ç¢ºèªæ–°å¯†ç¢¼</label>
                    <input type="password" id="confirm-password-input" class="input-magic mt-1 block w-full" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
            </div>
            <p id="change-password-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-change-password-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-change-password-btn" class="btn-magic bg-blue-600 hover:bg-blue-700 text-white py-2 px-4">ç¢ºèªæ›´æ”¹</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæ‰‹å‹•è£œç™»é©—è­‰å½ˆçª— -->
    <div id="manual-punch-auth-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ‰‹å‹•è£œç™»é©—è­‰</h3>
            <p class="text-sm text-gray-600 mb-4">æ­¤ç‚ºç‰¹æ®Šæ¬Šé™ï¼Œè«‹è¼¸å…¥é©—è­‰å¯†ç¢¼ã€‚</p>
            <input type="password" id="manual-punch-auth-input" class="input-magic w-full p-2 border rounded" placeholder="è«‹è¼¸å…¥è¶…ç´šå¯†ç¢¼...">
            <p id="manual-punch-auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-manual-punch-auth-btn" class="btn-magic bg-gray-300 hover:bg-gray-400 text-black py-2 px-4">å–æ¶ˆ</button>
                <button id="confirm-manual-punch-auth-btn" class="btn-magic bg-yellow-500 hover:bg-yellow-600 text-black py-2 px-4">ç¢ºèª</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const allElements = {
            date: document.getElementById('current-date'), time: document.getElementById('current-time'),
            punchInput: document.getElementById('punch-input'), shiftSelector: document.getElementById('shift-selector'),
            punchStatusSelector: document.getElementById('punch-status-selector'),
            messageBox: document.getElementById('message-box'), 
            togglePanelBtn: document.getElementById('toggle-panel-btn'), managementPanel: document.getElementById('management-panel'),
            toggleReportBtn: document.getElementById('toggle-report-btn'), reportPanel: document.getElementById('report-panel'),
            toggleFurnaceBtn: document.getElementById('toggle-furnace-btn'),
            emp: { id: document.getElementById('emp-id'), name: document.getElementById('emp-name'), gender: document.getElementById('emp-gender'), nationality: document.getElementById('emp-nationality'), dept: document.getElementById('emp-dept'), card: document.getElementById('emp-card'), password: document.getElementById('emp-password'), addBtn: document.getElementById('add-emp-btn'), importCsv: document.getElementById('import-emp-csv') },
            shiftSettings: document.getElementById('shift-settings'),
            manual: { card: document.getElementById('manual-card'), date: document.getElementById('manual-date'), time: document.getElementById('manual-time'), type: document.getElementById('manual-type'), punchBtn: document.getElementById('manual-punch-btn') },
            report: { startDate: document.getElementById('report-start-date'), endDate: document.getElementById('report-end-date'), generateBtn: document.getElementById('generate-report-btn'), exportBtn: document.getElementById('export-report-btn'), tableHead: document.getElementById('report-table-head'), tableBody: document.getElementById('report-table-body'), tableContainer: document.getElementById('report-table-container') },
            passwordModal: { overlay: document.getElementById('password-modal'), input: document.getElementById('admin-password-input'), error: document.getElementById('password-error'), confirmBtn: document.getElementById('confirm-password-btn'), cancelBtn: document.getElementById('cancel-password-btn'), changeBtn: document.getElementById('change-admin-password-btn') },
            reportAuthModal: { overlay: document.getElementById('report-auth-modal'), input: document.getElementById('report-auth-input'), error: document.getElementById('report-auth-error'), confirmBtn: document.getElementById('confirm-report-auth-btn'), cancelBtn: document.getElementById('cancel-report-auth-btn') },
            furnaceAuthModal: { overlay: document.getElementById('furnace-auth-modal'), input: document.getElementById('furnace-auth-input'), error: document.getElementById('furnace-auth-error'), confirmBtn: document.getElementById('confirm-furnace-auth-btn'), cancelBtn: document.getElementById('cancel-furnace-auth-btn'), changeBtn: document.getElementById('change-furnace-password-btn') },
            furnaceModal: { overlay: document.getElementById('furnace-modal'), closeBtn: document.getElementById('close-furnace-modal-btn') },
            employeeModal: { overlay: document.getElementById('employee-modal'), listBody: document.getElementById('employee-list-body'), manageBtn: document.getElementById('manage-employees-btn'), closeBtn: document.getElementById('close-employee-modal-btn'), exportBtn: document.getElementById('export-employees-btn') },
            confirmGenericModal: { overlay: document.getElementById('confirm-generic-modal'), title: document.getElementById('confirm-generic-title'), message: document.getElementById('confirm-generic-message'), confirmBtn: document.getElementById('confirm-generic-btn'), cancelBtn: document.getElementById('cancel-generic-btn') },
            clearRecords: { dateInput: document.getElementById('clear-records-date'), clearBtn: document.getElementById('clear-records-btn'), exportAllBtn: document.getElementById('export-all-records-btn') },
            bell: { 
                scheduleList: document.getElementById('bell-schedule-list'), addBtn: document.getElementById('add-bell-btn'), historyBtn: document.getElementById('bell-history-btn'), 
                modal: document.getElementById('bell-schedule-modal'), modalTitle: document.getElementById('bell-modal-title'), form: document.getElementById('bell-schedule-form'), 
                scheduleId: document.getElementById('bell-schedule-id'), title: document.getElementById('bell-title'), time: document.getElementById('bell-time'), 
                daysContainer: document.getElementById('bell-days-container'), soundSelect: document.getElementById('bell-sound'), durationInput: document.getElementById('bell-duration'), 
                cancelBtn: document.getElementById('bell-cancel-btn'), 
                historyModal: document.getElementById('bell-history-modal'), historyList: document.getElementById('bell-history-list'), 
                closeHistoryBtn: document.getElementById('bell-close-history-btn'), clearHistoryBtn: document.getElementById('clear-bell-history-btn'), 
                toastContainer: document.getElementById('bell-toast-container') 
            },
            soundManager: {
                manageBtn: document.getElementById('manage-sounds-btn'),
                modal: document.getElementById('sound-manager-modal'),
                closeBtn: document.getElementById('close-sound-manager-btn'),
                uploadInput: document.getElementById('sound-upload-input'),
                list: document.getElementById('sound-manager-list')
            },
            changePasswordModal: {
                overlay: document.getElementById('change-password-modal'),
                title: document.getElementById('change-password-title'),
                masterInput: document.getElementById('master-password-input'),
                newInput: document.getElementById('new-password-input'),
                confirmInput: document.getElementById('confirm-password-input'),
                error: document.getElementById('change-password-error'),
                confirmBtn: document.getElementById('confirm-change-password-btn'),
                cancelBtn: document.getElementById('cancel-change-password-btn')
            },
            manualPunchAuthModal: {
                overlay: document.getElementById('manual-punch-auth-modal'),
                input: document.getElementById('manual-punch-auth-input'),
                error: document.getElementById('manual-punch-auth-error'),
                confirmBtn: document.getElementById('confirm-manual-punch-auth-btn'),
                cancelBtn: document.getElementById('cancel-manual-punch-auth-btn')
            },
            autoTask: {
                list: document.getElementById('auto-task-list'),
                addBtn: document.getElementById('add-auto-task-btn'),
                cycle: document.getElementById('task-cycle'),
                time: document.getElementById('task-time'),
                dayWeeklyContainer: document.getElementById('task-day-weekly-container'),
                dayWeekly: document.getElementById('task-day-weekly'),
                dayMonthlyContainer: document.getElementById('task-day-monthly-container'),
                dayMonthly: document.getElementById('task-day-monthly'),
                name: document.getElementById('task-name'),
                target: document.getElementById('task-target'),
                deleteWarning: document.getElementById('task-delete-warning'),
                logList: document.getElementById('task-log-list')
            }
        };

        let employees = [], punchRecords = [], shifts = [], bell_schedules = [], bell_alarmHistory = [], customSounds = [], autoTasks = [], taskLog = [];
        let adminPassword, furnacePassword, lastLogResetTimestamp;
        let editingEmployeeId = null, lastCheckedMinute = -1, reportPanelTimeout, currentReportAuthId = null, genericConfirmCallback = null;
        let punchInputTimeout = null, passwordChangeTarget = null;
        let bell_lastCheckedMinute = -1, bell_toneStarted = false, bell_currentSound = null;
        
        const MASTER_CHANGE_PASSWORD = '0927';
        const MANUAL_PUNCH_PASSWORD = '0927';
        const DUPLICATE_PUNCH_MINUTES = 10;
        const REPORT_AUTO_CLOSE_MINUTES = 10;

        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const loadData = (key, defaultValue) => { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; };

        const showMessage = (text, type = 'info') => {
            const el = allElements.messageBox;
            el.textContent = text;
            el.className = 'message-box min-h-[60px] p-4 mb-6 rounded-lg text-center font-semibold text-lg show';
            const typeClasses = { success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800', info: 'bg-yellow-100 text-yellow-800' };
            el.classList.add(...(typeClasses[type] || typeClasses.info).split(' '));
            setTimeout(() => el.classList.remove('show'), 5000);
        };
        
        const flashPunchInput = (type) => {
            const el = allElements.punchInput;
            const className = type === 'success' ? 'flash-success' : 'shake-error';
            el.classList.add(className);
            setTimeout(() => el.classList.remove(className), 700);
        };

        const updateClock = () => {
            const now = new Date();
            allElements.date.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            allElements.time.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            const currentMinute = now.getMinutes();
            if (currentMinute !== lastCheckedMinute) { 
                determineCurrentShift(); 
                bell_checkSchedules();
                checkAutoTasks();
                lastCheckedMinute = currentMinute; 
            }
        };

        const executeManualPunch = () => {
            const { card, date, time, type } = allElements.manual;
            if (!card.value || !date.value || !time.value) {
                showMessage('è«‹å¡«å¯«å®Œæ•´çš„å¡è™Ÿ/å¯†ç¢¼ã€æ—¥æœŸèˆ‡æ™‚é–“ã€‚', 'error');
                return;
            }
            const punchDateTime = new Date(`${date.value}T${time.value}`);
            handlePunch(card.value, punchDateTime, type.value);
        };

        const handlePunch = (punchId, punchDateTime, manualType = null) => {
            if (punchInputTimeout) clearTimeout(punchInputTimeout);
            const id = punchId.trim();
            allElements.punchInput.value = '';

            if (!id) { showMessage('è«‹è¼¸å…¥å¡è™Ÿæˆ–å¯†ç¢¼ï¼', 'error'); flashPunchInput('error'); allElements.punchInput.focus(); return; }
            const employee = employees.find(emp => emp.card === id || emp.password === id);
            if (!employee) { showMessage(`æ‰¾ä¸åˆ°å¡è™Ÿ/å¯†ç¢¼ç‚º ${id} çš„å“¡å·¥ã€‚`, 'error'); flashPunchInput('error'); allElements.punchInput.focus(); return; }
            
            flashPunchInput('success'); 
            const now = punchDateTime || new Date();
            const todayStr = now.toISOString().split('T')[0];
            const todayRecords = punchRecords.filter(r => r.employeeId === employee.id && r.timestamp.startsWith(todayStr)).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const lastRecord = todayRecords[todayRecords.length - 1];
            let punchType;

            const manualStatus = allElements.punchStatusSelector.value;
            if (manualStatus !== 'auto') {
                punchType = manualStatus;
            } else if (manualType) {
                punchType = manualType;
            } else {
                if (lastRecord) {
                    const timeDiff = now.getTime() - new Date(lastRecord.timestamp).getTime();
                    if (timeDiff < DUPLICATE_PUNCH_MINUTES * 60 * 1000) { showMessage(`${employee.name}ï¼Œæ‚¨åœ¨çŸ­æ™‚é–“å†…é‡è¤‡æ‰“å¡äº†ï¼`, 'info'); punchType = 'duplicate'; }
                }
                if (!punchType) { const validPunchesToday = todayRecords.filter(r => r.type === 'in' || r.type === 'out'); punchType = (validPunchesToday.length % 2 === 0) ? 'in' : 'out'; }
            }

            const newRecord = { recordId: `rec_${Date.now()}`, employeeId: employee.id, name: employee.name, type: punchType, timestamp: now.toISOString(), shift: allElements.shiftSelector.value };
            punchRecords.push(newRecord);
            saveData('punch_records_v2', punchRecords);
            let typeText = {'in': 'ä¸Šç­', 'out': 'ä¸‹ç­', 'duplicate': 'é‡è¤‡æ‰“å¡'}[punchType] || '';
            showMessage(`${employee.name}ï¼Œ${typeText}ç´€éŒ„æˆåŠŸï¼æ™‚é–“ï¼š${now.toLocaleTimeString('zh-TW', {hour12: false})}`, 'success');
            allElements.punchStatusSelector.value = 'auto';
            allElements.punchInput.focus();
        };

        const determineCurrentShift = () => {
            const now = new Date();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            let activeShift = null;
            for (const shift of shifts) {
                if (shift.start && shift.end) {
                    const [startH, startM] = shift.start.split(':').map(Number);
                    const [endH, endM] = shift.end.split(':').map(Number);
                    const startTime = startH * 60 + startM;
                    const endTime = endH * 60 + endM;
                    if (endTime < startTime) { if (currentTimeInMinutes >= startTime || currentTimeInMinutes < endTime) { activeShift = shift; break; } } 
                    else { if (currentTimeInMinutes >= startTime && currentTimeInMinutes < endTime) { activeShift = shift; break; } }
                }
            }
            if (activeShift) { allElements.shiftSelector.value = activeShift.name; return; }
            const validShifts = shifts.filter(s => s.name && s.start && s.end).map(s => ({ ...s, startTimeInMinutes: s.start.split(':')[0] * 60 + s.start.split(':')[1] * 1 })).sort((a, b) => a.startTimeInMinutes - b.startTimeInMinutes);
            const nextShiftToday = validShifts.find(s => s.startTimeInMinutes > currentTimeInMinutes);
            if (nextShiftToday) { allElements.shiftSelector.value = nextShiftToday.name; } 
            else if (validShifts.length > 0) { allElements.shiftSelector.value = validShifts[0].name; }
        };

        const populateShiftSelector = () => {
            allElements.shiftSelector.innerHTML = '';
            shifts.forEach(shift => {
                if(shift.name && shift.start && shift.end) {
                    const option = document.createElement('option');
                    option.value = shift.name;
                    option.textContent = `${shift.name} (${shift.start} - ${shift.end})`;
                    allElements.shiftSelector.appendChild(option);
                }
            });
            determineCurrentShift();
        };

        const renderShiftSettings = () => {
            allElements.shiftSettings.innerHTML = '';
            shifts.forEach((shift, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `<input type="text" value="${shift.name}" placeholder="ç­åˆ¥åç¨±" class="input-magic w-1/3 p-1 border rounded shift-name" data-index="${index}"><input type="time" value="${shift.start}" class="input-magic w-1/3 p-1 border rounded shift-start" data-index="${index}"><input type="time" value="${shift.end}" class="input-magic w-1/3 p-1 border rounded shift-end" data-index="${index}">`;
                allElements.shiftSettings.appendChild(div);
            });
            allElements.shiftSettings.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const prop = e.target.classList.contains('shift-name') ? 'name' : (e.target.classList.contains('shift-start') ? 'start' : 'end');
                    shifts[index][prop] = e.target.value;
                    saveData('shifts_v2', shifts);
                    populateShiftSelector();
                    showMessage('ç­åˆ¥è¨­å®šå·²æ›´æ–°ã€‚', 'info');
                });
            });
        };
        
        const renderEmployeeList = () => {
            allElements.employeeModal.listBody.innerHTML = '';
            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.dataset.id = emp.id;
                row.innerHTML = `<td class="py-2 px-2">${emp.id}</td><td class="py-2 px-2">${emp.name}</td><td class="py-2 px-2">${emp.department}</td> <td class="py-2 px-2">${emp.gender}</td><td class="py-2 px-2">${emp.nationality}</td> <td class="py-2 px-2">${emp.card}</td><td class="py-2 px-2">${emp.password}</td><td class="py-2 px-2"><button class="text-blue-500 hover:text-blue-700 text-xs edit-btn" data-id="${emp.id}">ç·¨è¼¯</button><button class="text-red-500 hover:text-red-700 text-xs ml-2 delete-btn" data-id="${emp.id}">åˆªé™¤</button></td>`;
                allElements.employeeModal.listBody.appendChild(row);
            });
        };
        
        const handleEmployeeFormSubmit = () => {
            const { id, name, gender, nationality, dept, card, password } = allElements.emp;
            const empData = { id: id.value.trim().toUpperCase(), name: name.value.trim(), gender: gender.value.trim(), nationality: nationality.value.trim(), department: dept.value.trim(), card: card.value.trim(), password: password.value.trim() };
            if (!empData.id || !empData.name || !empData.department || !empData.card || !empData.password) { showMessage('å·¥è™Ÿã€å§“åã€éƒ¨é–€ã€å¡è™Ÿå’Œå¯†ç¢¼ç‚ºå¿…å¡«æ¬„ä½ã€‚', 'error'); return; }
            if (editingEmployeeId) {
                const index = employees.findIndex(e => e.id === editingEmployeeId);
                if (index > -1) { employees[index] = { ...employees[index], ...empData }; showMessage(`å“¡å·¥ ${empData.name} çš„è³‡æ–™å·²æ›´æ–°ã€‚`, 'success'); }
            } else {
                if (employees.some(e => e.id === empData.id || e.card === empData.card)) { showMessage(`å·¥è™Ÿ ${empData.id} æˆ–å¡è™Ÿ ${empData.card} å·²å­˜åœ¨ã€‚`, 'error'); return; }
                employees.push(empData); showMessage(`å“¡å·¥ ${empData.name} å·²æˆåŠŸæ–°å¢ï¼`, 'success');
            }
            saveData('employees_v2', employees); renderEmployeeList(); resetEmployeeForm();
        };

        const resetEmployeeForm = () => {
            Object.values(allElements.emp).forEach(input => { if(input.tagName === 'INPUT') input.value = ''; });
            allElements.emp.id.disabled = false; allElements.emp.addBtn.textContent = 'æ–°å¢/æ›´æ–°å“¡å·¥'; editingEmployeeId = null;
        };

        const loadEmployeesFromCSV = (file) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const lines = event.target.result.split(/\r?\n/); let addedCount = 0; let skippedCount = 0;
                for(let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim(); if (!line) continue;
                    const columns = line.split(',').map(s => { let str = s.trim(); if (str.startsWith('"') && str.endsWith('"')) { return str.substring(1, str.length - 1); } return str; });
                    if (columns.length !== 7) { skippedCount++; continue; }
                    const [id, name, gender, nationality, department, card, password] = columns;
                    if (id && name && department && card && password && !employees.some(emp => emp.id === id)) { employees.push({ id, name, gender, nationality, department, card, password }); addedCount++; } else { skippedCount++; }
                }
                saveData('employees_v2', employees); renderEmployeeList(); showMessage(`æˆåŠŸåŒ¯å…¥ ${addedCount} ä½å“¡å·¥ï¼Œè·³é ${skippedCount} ç­†æ ¼å¼ä¸ç¬¦æˆ–å·²å­˜åœ¨çš„è³‡æ–™ã€‚`, 'success');
            };
            reader.readAsText(file, 'UTF-8');
        };

        const openPasswordModal = () => { allElements.passwordModal.overlay.classList.add('show'); allElements.passwordModal.input.focus(); allElements.passwordModal.input.value = ''; allElements.passwordModal.error.textContent = ''; };
        const closePasswordModal = () => allElements.passwordModal.overlay.classList.remove('show');
        const checkPassword = () => {
            if (allElements.passwordModal.input.value === adminPassword) {
                closePasswordModal(); const panel = allElements.managementPanel; panel.style.maxHeight = panel.scrollHeight + "px";
            } else { allElements.passwordModal.error.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚'; }
        };
        const openEmployeeModal = () => { renderEmployeeList(); allElements.employeeModal.overlay.classList.add('show'); };
        const closeEmployeeModal = () => allElements.employeeModal.overlay.classList.remove('show');
        
        const handleClearRecords = () => {
            const date = allElements.clearRecords.dateInput.value; if(!date) { showMessage('è«‹é¸æ“‡è¦æ¸…ç†çš„æ—¥æœŸã€‚', 'error'); return; }
            showGenericConfirm('æ¸…ç†èˆŠç´€éŒ„', `æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ ${date} (å«) ä¹‹å‰çš„æ‰€æœ‰æ‰“å¡ç´€éŒ„ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`, () => {
                const dateStr = allElements.clearRecords.dateInput.value; const cutoffDate = new Date(dateStr); cutoffDate.setHours(23, 59, 59, 999);
                const originalCount = punchRecords.length; punchRecords = punchRecords.filter(record => new Date(record.timestamp) > cutoffDate);
                saveData('punch_records_v2', punchRecords);
                showMessage(`ä½œæ¥­å®Œæˆï¼ŒæˆåŠŸæ¸…ç†äº† ${originalCount - punchRecords.length} ç­†èˆŠç´€éŒ„ã€‚`, 'success');
            });
        };
        
        const showGenericConfirm = (title, message, onConfirm) => {
            allElements.confirmGenericModal.title.textContent = title;
            allElements.confirmGenericModal.message.textContent = message;
            genericConfirmCallback = onConfirm;
            allElements.confirmGenericModal.overlay.classList.add('show');
        };

        const handleGlobalKeyPress = (e) => {
            const activeEl = document.activeElement; const isModalOpen = document.querySelector('.modal-overlay.show');
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeEl.tagName);
            if (!isInputFocused && !isModalOpen) { 
                if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) { 
                    e.preventDefault(); 
                    allElements.punchInput.value = '';
                    allElements.punchInput.focus(); 
                    allElements.punchInput.value = e.key; 
                } 
            }
        };

        const closeReportPanel = () => {
            const panel = allElements.reportPanel;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
                allElements.report.tableBody.innerHTML = '';
                allElements.report.tableHead.innerHTML = '';
                if (reportPanelTimeout) { clearTimeout(reportPanelTimeout); }
                showMessage('è€ƒå‹¤å ±è¡¨å·²é—œé–‰ã€‚', 'info');
            }
        };
        
        const openReportPanel = (authId) => {
            currentReportAuthId = authId;
            allElements.reportAuthModal.overlay.classList.remove('show');
            allElements.reportAuthModal.input.value = '';
            
            const panel = allElements.reportPanel;
            panel.style.maxHeight = panel.scrollHeight + "px";
            
            if (reportPanelTimeout) clearTimeout(reportPanelTimeout);
            reportPanelTimeout = setTimeout(closeReportPanel, REPORT_AUTO_CLOSE_MINUTES * 60 * 1000);
            
            showMessage('è«‹è¨­å®šæ—¥æœŸå€é–“å¾Œç”¢ç”Ÿå ±è¡¨ã€‚', 'info');
        };

        const generateReportData = () => {
            if (!currentReportAuthId) {
                showMessage('ç„¡æ•ˆçš„æˆæ¬Šï¼Œè«‹é‡æ–°é–‹å•Ÿå ±è¡¨ã€‚', 'error');
                closeReportPanel();
                return;
            }
            const startDateStr = allElements.report.startDate.value; const endDateStr = allElements.report.endDate.value;
            if (!startDateStr || !endDateStr) { showMessage('è«‹é¸æ“‡å ±è¡¨çš„èµ·å§‹èˆ‡çµæŸæ—¥æœŸã€‚', 'error'); return; }
            const startDate = new Date(startDateStr); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr); endDate.setHours(23, 59, 59, 999);
            if (startDate > endDate) { showMessage('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚', 'error'); return; }

            let recordsToDisplay = [];
            if (currentReportAuthId === adminPassword) {
                recordsToDisplay = punchRecords.filter(r => { const d = new Date(r.timestamp); return d >= startDate && d <= endDate; });
            } else {
                const employee = employees.find(emp => emp.card === currentReportAuthId || emp.password === currentReportAuthId);
                if (!employee) { showMessage('æ‰¾ä¸åˆ°æ­¤å¡è™Ÿ/å¯†ç¢¼å°æ‡‰çš„å“¡å·¥ã€‚', 'error'); return; }
                recordsToDisplay = punchRecords.filter(r => r.employeeId === employee.id && (new Date(r.timestamp) >= startDate && new Date(r.timestamp) <= endDate));
            }
            
            allElements.report.tableHead.innerHTML = `<tr><th class="py-2 px-3 text-left">å·¥è™Ÿ</th><th class="py-2 px-3 text-left">å§“å</th><th class="py-2 px-3 text-left">æ‰“å¡æ—¥æœŸ</th><th class="py-2 px-3 text-left">æ‰“å¡æ™‚é–“</th><th class="py-2 px-3 text-left">ç­åˆ¥(æ™‚æ®µ)</th><th class="py-2 px-3 text-left">ç‹€æ…‹</th></tr>`;
            allElements.report.tableBody.innerHTML = '';
            
            if (recordsToDisplay.length === 0) { allElements.report.tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">è©²æ¢ä»¶ä¸‹æ²’æœ‰ä»»ä½•æ‰“å¡ç´€éŒ„ã€‚</td></tr>`; } 
            else {
                recordsToDisplay.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(record => {
                    const punchDate = new Date(record.timestamp); const row = document.createElement('tr');
                    let statusText = {'in': 'ä¸Šç­', 'out': 'ä¸‹ç­', 'duplicate': '<span class="text-orange-500 font-bold">é‡è¤‡æ‰“å¡</span>'}[record.type] || 'æœªçŸ¥';
                    row.innerHTML = `<td class="py-2 px-3 border-b">${record.employeeId}</td><td class="py-2 px-3 border-b">${record.name}</td><td class="py-2 px-3 border-b">${punchDate.toLocaleDateString('zh-TW')}</td><td class="py-2 px-3 border-b">${punchDate.toLocaleTimeString('zh-TW', {hour12: false})}</td><td class="py-2 px-3 border-b">${record.shift}</td><td class="py-2 px-3 border-b">${statusText}</td>`;
                    allElements.report.tableBody.appendChild(row);
                });
            }
            
            setTimeout(() => {
                const panel = allElements.reportPanel;
                panel.style.maxHeight = panel.scrollHeight + "px";
            }, 10);

            showMessage('å ±è¡¨å·²ç”¢ç”Ÿã€‚', 'success');
        };
        
        const exportToCSV = (data, filename) => {
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + data.join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        
        const updateManagementPanelHeight = () => {
            const panel = allElements.managementPanel;
            if (panel.style.maxHeight && panel.style.maxHeight !== "0px") {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        };

        const bell_initAudio = async () => { if (bell_toneStarted) return; try { await Tone.start(); bell_toneStarted = true; showMessage("éŸ¿éˆ´åŠŸèƒ½å·²å•Ÿå‹•ï¼", "success"); } catch (e) { console.error("Tone.js å•Ÿå‹•å¤±æ•—:", e); showMessage("éŸ³æ•ˆåŠŸèƒ½å•Ÿå‹•å¤±æ•—", "error"); } };
        const bell_checkSchedules = () => { if (!bell_toneStarted || document.hidden) return; const now = new Date(); const currentMinute = now.getMinutes(); if (currentMinute === bell_lastCheckedMinute) return; bell_lastCheckedMinute = currentMinute; const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; const currentDay = now.getDay(); bell_schedules.forEach(schedule => { if (schedule.time === currentTime && schedule.days.includes(currentDay)) { bell_triggerAlarm(schedule); } }); };
        const bell_stopCurrentSound = () => { if (bell_currentSound) { if (bell_currentSound.isTone) { if (Tone.Transport.state === 'started') Tone.Transport.stop(); bell_currentSound.part.stop(0).dispose(); } else { bell_currentSound.player.pause(); bell_currentSound.player.currentTime = 0; } bell_currentSound = null; } };
        
        const bell_playSound = (schedule) => {
            bell_stopCurrentSound();
            const defaultSounds = {
                'default': [{ time: '0:0', note: 'G4' }, { time: '0:2', note: 'G4' }],
                'forest': [{ time: '0:0', note: 'C4' }, { time: '0:1', note: 'E4' }, { time: '0:2', note: 'G4' }],
                'crystal': [{ time: '0:0', note: 'C5' }, { time: '0:1', note: 'E5' }, { time: '0:2', note: 'G5' }, { time: '0:3', note: 'C6' }]
            };

            if (defaultSounds[schedule.sound]) {
                const synth = new Tone.Synth().toDestination();
                const melody = defaultSounds[schedule.sound];
                const part = new Tone.Part((time, value) => {
                    synth.triggerAttackRelease(value.note, '8n', time);
                }, melody).start(0);
                part.loop = true;
                part.loopEnd = '1m';
                Tone.Transport.start();
                bell_currentSound = { isTone: true, part: part };
                setTimeout(bell_stopCurrentSound, schedule.duration * 1000);
            } else {
                const customSound = customSounds.find(s => s.id === schedule.sound);
                if (customSound && customSound.data) {
                    const audioPlayer = new Audio(customSound.data);
                    audioPlayer.play().catch(e => console.error("è‡ªè¨‚éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e));
                    bell_currentSound = { isTone: false, player: audioPlayer };
                    setTimeout(bell_stopCurrentSound, schedule.duration * 1000);
                } else {
                    console.warn(`æ‰¾ä¸åˆ°éŸ³æ•ˆ: ${schedule.sound}ï¼Œæ’­æ”¾é è¨­éŸ³æ•ˆã€‚`);
                    schedule.sound = 'default'; // é™ç´šç‚ºé è¨­
                    bell_playSound(schedule);
                }
            }
        };

        const bell_triggerAlarm = (schedule) => { bell_playSound(schedule); const lastRecord = bell_alarmHistory[0]; if (!lastRecord || lastRecord.title !== schedule.title || (Date.now() - lastRecord.timestamp > 60000)) { bell_alarmHistory.unshift({ title: schedule.title, time: schedule.time, timestamp: Date.now() }); saveData('bell_history_v3', bell_alarmHistory); } const toast = document.createElement('div'); toast.className = 'bell-toast show'; toast.innerHTML = `<div class="font-bold">ğŸ”” ${schedule.title}</div><div class="text-sm opacity-80">ç¾åœ¨æ˜¯ ${schedule.time}ï¼Œè©²é€²è¡Œä¸‹å€‹æ´»å‹•äº†ï¼</div>`; allElements.bell.toastContainer.appendChild(toast); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 7000); };
        const bell_renderSchedules = () => { const listEl = allElements.bell.scheduleList; listEl.innerHTML = ''; if (bell_schedules.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-500 py-4">é‚„æ²’æœ‰è¨­å®šä»»ä½•éŸ¿éˆ´å–”ï¼</p>`; } else { bell_schedules.sort((a, b) => a.time.localeCompare(b.time)); bell_schedules.forEach(schedule => { const itemEl = document.createElement('div'); itemEl.className = 'bg-gray-50 p-3 rounded-lg flex items-center justify-between border-l-4 border-blue-400'; itemEl.dataset.id = schedule.id; const dayMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; let repeatText = schedule.days.length === 7 ? 'æ¯æ—¥' : schedule.days.sort().map(d => `é€±${dayMap[d]}`).join('ã€'); itemEl.innerHTML = `<div><p class="font-bold text-md text-gray-800">${schedule.title}</p><p class="text-sm text-gray-600">${schedule.time} | ${repeatText}</p></div><div class="flex items-center space-x-2"><button class="bell-edit-btn text-gray-400 hover:text-blue-600 p-1" title="ç·¨è¼¯"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button><button class="bell-delete-btn text-gray-400 hover:text-red-600 p-1" title="åˆªé™¤"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`; listEl.appendChild(itemEl); }); } updateManagementPanelHeight(); };
        const bell_renderHistory = () => { const listEl = allElements.bell.historyList; listEl.innerHTML = ''; if (bell_alarmHistory.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>`; return; } bell_alarmHistory.forEach(record => { const itemEl = document.createElement('div'); itemEl.className = 'bg-gray-100 p-3 rounded-lg flex items-center justify-between'; const d = new Date(record.timestamp); const dateStr = d.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }); const timeStr = d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }); itemEl.innerHTML = `<div><p class="font-bold text-md text-gray-700">${record.title}</p><p class="text-sm text-gray-500">éŸ¿éˆ´æ–¼ï¼š${dateStr} ${timeStr}</p></div><span class="text-sm font-medium text-gray-600">${record.time}</span>`; listEl.appendChild(itemEl); }); };
        
        const bell_populateSoundSelector = () => {
            const select = allElements.bell.soundSelect;
            const currentValue = select.value;
            select.innerHTML = `
                <optgroup label="é è¨­éŸ³æ•ˆ">
                    <option value="default">é è¨­éˆ´è²</option>
                    <option value="forest">æ£®æ—è€³èª</option>
                    <option value="crystal">æ°´æ™¶é¢¨éˆ´</option>
                </optgroup>
            `;
            if (customSounds.length > 0) {
                const customGroup = document.createElement('optgroup');
                customGroup.label = 'è‡ªè¨‚è²éŸ³';
                customSounds.forEach(sound => {
                    const option = document.createElement('option');
                    option.value = sound.id;
                    option.textContent = sound.name;
                    customGroup.appendChild(option);
                });
                select.appendChild(customGroup);
            }
            select.value = currentValue;
        };

        const bell_openModal = (schedule = null) => { 
            const { form, durationInput, daysContainer, modalTitle, scheduleId, title, time, soundSelect, modal } = allElements.bell; 
            form.reset(); 
            durationInput.value = 5; 
            daysContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); 
            bell_populateSoundSelector();
            if (schedule) { 
                modalTitle.textContent = 'ä¿®æ”¹éŸ¿éˆ´å ´æ™¯'; 
                scheduleId.value = schedule.id; 
                title.value = schedule.title; 
                time.value = schedule.time; 
                soundSelect.value = schedule.sound; 
                durationInput.value = schedule.duration; 
                schedule.days.forEach(day => { const cb = daysContainer.querySelector(`input[value="${day}"]`); if (cb) cb.checked = true; }); 
            } else { 
                modalTitle.textContent = 'æ–°å¢éŸ¿éˆ´å ´æ™¯'; 
                scheduleId.value = ''; 
            } 
            modal.classList.add('show'); 
        };
        const bell_closeModal = () => allElements.bell.modal.classList.remove('show');
        const bell_openHistoryModal = () => { bell_renderHistory(); allElements.bell.historyModal.classList.add('show'); };
        const bell_closeHistoryModal = () => allElements.bell.historyModal.classList.remove('show');

        // --- Sound Manager Functions ---
        const openSoundManager = () => {
            renderSoundManagerList();
            allElements.soundManager.modal.classList.add('show');
        };
        const closeSoundManager = () => {
            allElements.soundManager.modal.classList.remove('show');
        };
        const renderSoundManagerList = () => {
            const listEl = allElements.soundManager.list;
            listEl.innerHTML = '';
            if (customSounds.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 py-4">è²éŸ³åº«ç›®å‰æ˜¯ç©ºçš„ã€‚</p>`;
                return;
            }
            customSounds.forEach(sound => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-3 rounded-lg flex items-center justify-between';
                itemEl.innerHTML = `
                    <p class="text-gray-700 truncate pr-4">${sound.name}</p>
                    <button class="sound-delete-btn text-red-400 hover:text-red-600 p-1" data-id="${sound.id}" title="åˆªé™¤">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                listEl.appendChild(itemEl);
            });
        };
        const handleSoundUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const soundData = {
                    id: `snd_${Date.now()}`,
                    name: file.name,
                    data: event.target.result
                };
                customSounds.push(soundData);
                saveData('custom_sounds_v2', customSounds);
                renderSoundManagerList();
                showMessage(`è²éŸ³æª”ã€Œ${file.name}ã€å·²æ–°å¢ï¼`, 'success');
                e.target.value = ''; // Reset input
            };
            reader.readAsDataURL(file);
        };
        const handleDeleteSound = (soundId) => {
            const sound = customSounds.find(s => s.id === soundId);
            if (!sound) return;

            showGenericConfirm('åˆªé™¤è²éŸ³æª”', `ç¢ºå®šè¦åˆªé™¤ã€Œ${sound.name}ã€é€™å€‹è²éŸ³æª”å—ï¼Ÿ`, () => {
                customSounds = customSounds.filter(s => s.id !== soundId);
                saveData('custom_sounds_v2', customSounds);
                renderSoundManagerList();
                showMessage(`è²éŸ³æª”å·²åˆªé™¤ã€‚`, 'info');
            });
        };

        // --- Password Change Functions ---
        const openChangePasswordModal = (target) => {
            passwordChangeTarget = target;
            const { overlay, title, masterInput, newInput, confirmInput, error } = allElements.changePasswordModal;
            title.textContent = target === 'admin' ? 'æ›´æ”¹ç®¡ç†è€…å¯†ç¢¼' : 'æ›´æ”¹è€ƒå‹¤åº«å¯†ç¢¼';
            masterInput.value = '';
            newInput.value = '';
            confirmInput.value = '';
            error.textContent = '';
            overlay.classList.add('show');
        };

        const closeChangePasswordModal = () => {
            allElements.changePasswordModal.overlay.classList.remove('show');
        };

        const handleChangePassword = () => {
            const { masterInput, newInput, confirmInput, error } = allElements.changePasswordModal;
            const masterPass = masterInput.value;
            const newPass = newInput.value;
            const confirmPass = confirmInput.value;

            if (masterPass !== MASTER_CHANGE_PASSWORD) {
                error.textContent = 'è¶…ç´šå¯†ç¢¼éŒ¯èª¤ï¼';
                return;
            }
            if (!newPass || newPass !== confirmPass) {
                error.textContent = 'æ–°å¯†ç¢¼ä¸èƒ½ç‚ºç©ºæˆ–å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´ã€‚';
                return;
            }

            if (passwordChangeTarget === 'admin') {
                adminPassword = newPass;
                saveData('admin_password_v1', adminPassword);
                showMessage('ç®¡ç†è€…å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else if (passwordChangeTarget === 'furnace') {
                furnacePassword = newPass;
                saveData('furnace_password_v1', furnacePassword);
                showMessage('è€ƒå‹¤æª”æ¡ˆåº«å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            }
            closeChangePasswordModal();
        };

        // --- Auto Task Functions ---
        const logTaskExecution = (success, message) => {
            taskLog.unshift({ timestamp: Date.now(), success, message });
            if (taskLog.length > 100) taskLog.pop(); // Keep log size manageable
            saveData('task_log_v1', taskLog);
            renderTaskLog();
        };
        
        const renderTaskLog = () => {
            const listEl = allElements.autoTask.logList;
            listEl.innerHTML = '';
            if (taskLog.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 py-2">å°šç„¡ä»»å‹™æ—¥èªŒ</p>`;
                return;
            }
            taskLog.forEach(log => {
                const d = new Date(log.timestamp);
                const timeStr = d.toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour: '2-digit', minute:'2-digit', second: '2-digit', hour12: false });
                const colorClass = log.success ? 'text-green-600' : 'text-red-600';
                const icon = log.success ? 'âœ“' : 'âœ—';
                const itemEl = document.createElement('div');
                itemEl.className = 'text-gray-700';
                itemEl.innerHTML = `<span class="font-mono text-xs text-gray-500">${timeStr}</span> <span class="${colorClass}">${icon}</span> ${log.message}`;
                listEl.appendChild(itemEl);
            });
        };

        const renderAutoTasks = () => {
            const listEl = allElements.autoTask.list;
            listEl.innerHTML = '';
            if (autoTasks.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 py-4">å°šç„¡è‡ªå‹•ä»»å‹™</p>`;
                return;
            }
            const dayMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            autoTasks.forEach(task => {
                const cycleText = task.cycle === 'weekly' ? 'æ¯å‘¨' : 'æ¯æœˆ';
                const dayText = task.cycle === 'weekly' ? dayMap[task.day] : `${task.day}è™Ÿ`;
                const taskText = task.name === 'export' ? 'åŒ¯å‡º' : 'åˆªé™¤';
                let targetText;
                switch(task.target) {
                    case 'last_week': targetText = 'ä¸Šé€±æ‰“å¡ç´€éŒ„'; break;
                    case 'last_month': targetText = 'ä¸Šå€‹æœˆæ‰“å¡ç´€éŒ„'; break;
                    case 'last_week_bell': targetText = 'ä¸Šé€±éŸ¿éˆ´ç´€éŒ„'; break;
                    case 'task_log': targetText = 'ç³»çµ±ä»»å‹™æ—¥èªŒ'; break;
                    default: targetText = 'æœªçŸ¥ç›®æ¨™';
                }
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-gray-50 p-2 rounded-lg flex items-center justify-between text-sm';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-semibold">${cycleText} ${dayText} ${task.time}</p>
                        <p class="text-xs text-gray-600">${taskText} ${targetText}</p>
                    </div>
                    <button class="delete-auto-task-btn text-red-400 hover:text-red-600 p-1" data-id="${task.id}" title="åˆªé™¤ä»»å‹™">&times;</button>
                `;
                listEl.appendChild(itemEl);
            });
        };
        
        const handleAddTask = () => {
            const { cycle, time, dayWeekly, dayMonthly, name, target } = allElements.autoTask;
            const newTask = {
                id: `task_${Date.now()}`,
                cycle: cycle.value,
                time: time.value,
                day: cycle.value === 'weekly' ? parseInt(dayWeekly.value) : parseInt(dayMonthly.value),
                name: name.value,
                target: target.value,
                lastRun: null // To prevent running multiple times
            };
            autoTasks.push(newTask);
            saveData('auto_tasks_v1', autoTasks);
            renderAutoTasks();
        };
        
        const checkAutoTasks = () => {
            const now = new Date();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;

            // Reset log every Monday
            if (now.getDay() === 1 && (!lastLogResetTimestamp || now.getTime() - lastLogResetTimestamp > oneWeek)) {
                 taskLog = [];
                 saveData('task_log_v1', taskLog);
                 lastLogResetTimestamp = now.getTime();
                 saveData('last_log_reset_v1', lastLogResetTimestamp);
                 logTaskExecution(true, 'ç³»çµ±ä»»å‹™æ—¥èªŒå·²æ–¼é€±ä¸€è‡ªå‹•é‡ç½®ã€‚');
            }

            autoTasks.forEach(task => {
                const [taskH, taskM] = task.time.split(':').map(Number);
                let shouldRun = false;
                
                if (now.getHours() === taskH && now.getMinutes() === taskM) {
                    if (task.cycle === 'weekly') {
                        if (now.getDay() === task.day) {
                            shouldRun = true;
                        }
                    } else if (task.cycle === 'monthly') {
                        if (now.getDate() === task.day) {
                            shouldRun = true;
                        }
                    }
                }

                if (shouldRun) {
                    const todayStr = now.toISOString().split('T')[0];
                    if (task.lastRun !== todayStr) { // Check if it already ran today
                        task.lastRun = todayStr;
                        executeAutoTask(task);
                        saveData('auto_tasks_v1', autoTasks); // Save lastRun update
                    }
                }
            });
        };

        const executeAutoTask = (task) => {
            logTaskExecution(true, `é–‹å§‹åŸ·è¡Œä»»å‹™: ${task.name} ${task.target}`);
            const now = new Date();
            let startDate, endDate;

            if (task.target === 'last_week' || task.target === 'last_week_bell') {
                const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const dayOfWeek = lastWeek.getDay();
                const diff = lastWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                startDate = new Date(lastWeek.setDate(diff));
                startDate.setHours(0,0,0,0);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23,59,59,999);
            } else if (task.target === 'last_month') {
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                startDate = new Date(lastMonth);
                startDate.setHours(0,0,0,0);
                endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                endDate.setHours(23,59,59,999);
            }

            if (task.name === 'export' && task.target !== 'last_week_bell' && task.target !== 'task_log') {
                const recordsToExport = punchRecords.filter(r => {
                    const d = new Date(r.timestamp);
                    return d >= startDate && d <= endDate;
                });
                const headers = ['å·¥è™Ÿ,å§“å,æ‰“å¡æ—¥æœŸ,æ‰“å¡æ™‚é–“,ç­åˆ¥(æ™‚æ®µ),ç‹€æ…‹'];
                const rows = recordsToExport.map(r => {
                    const d = new Date(r.timestamp); 
                    const s = {'in': 'ä¸Šç­', 'out': 'ä¸‹ç­', 'duplicate': 'é‡è¤‡æ‰“å¡'}[r.type] || 'æœªçŸ¥'; 
                    return [r.employeeId, r.name, d.toLocaleDateString('zh-TW'), d.toLocaleTimeString('zh-TW', {hour12: false}), r.shift, s].map(f => `"${String(f || '').replace(/"/g, '""')}"`).join(',');
                });
                const filename = `records_${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}.csv`;
                exportToCSV(headers.concat(rows), filename);
                logTaskExecution(true, `ä»»å‹™æˆåŠŸ: åŒ¯å‡ºäº† ${recordsToExport.length} ç­†ç´€éŒ„ã€‚`);
            } else if (task.name === 'delete') {
                if (task.target === 'last_week' || task.target === 'last_month') {
                    const originalCount = punchRecords.length;
                    punchRecords = punchRecords.filter(r => {
                        const d = new Date(r.timestamp);
                        return d < startDate || d > endDate;
                    });
                    saveData('punch_records_v2', punchRecords);
                    logTaskExecution(true, `ä»»å‹™æˆåŠŸ: åˆªé™¤äº† ${originalCount - punchRecords.length} ç­†æ‰“å¡ç´€éŒ„ã€‚`);
                } else if (task.target === 'last_week_bell') {
                    const originalCount = bell_alarmHistory.length;
                    bell_alarmHistory = bell_alarmHistory.filter(r => {
                        const d = new Date(r.timestamp);
                        return d < startDate || d > endDate;
                    });
                    saveData('bell_history_v3', bell_alarmHistory);
                    logTaskExecution(true, `ä»»å‹™æˆåŠŸ: åˆªé™¤äº† ${originalCount - bell_alarmHistory.length} ç­†ä¸Šé€±çš„éŸ¿éˆ´ç´€éŒ„ã€‚`);
                } else if (task.target === 'task_log') {
                    const originalCount = taskLog.length;
                    taskLog = [];
                    saveData('task_log_v1', taskLog);
                    renderTaskLog();
                    logTaskExecution(true, `ä»»å‹™æˆåŠŸ: åˆªé™¤äº† ${originalCount} ç­†ç³»çµ±ä»»å‹™æ—¥èªŒã€‚`);
                }
            }
        };


        const initializeEventListeners = () => {
            allElements.togglePanelBtn.addEventListener('click', () => {
                const panel = allElements.managementPanel;
                if (panel.style.maxHeight && panel.style.maxHeight !== "0px") {
                    panel.style.maxHeight = null;
                } else {
                    openPasswordModal();
                }
            });
            allElements.passwordModal.confirmBtn.addEventListener('click', checkPassword);
            allElements.passwordModal.cancelBtn.addEventListener('click', closePasswordModal);
            allElements.passwordModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkPassword(); });
            
            allElements.toggleReportBtn.addEventListener('click', () => {
                const panel = allElements.reportPanel;
                if (panel.style.maxHeight) { closeReportPanel(); } 
                else { allElements.reportAuthModal.overlay.classList.add('show'); allElements.reportAuthModal.input.focus(); allElements.reportAuthModal.error.textContent = ''; }
            });
            allElements.reportAuthModal.confirmBtn.addEventListener('click', () => {
                const authId = allElements.reportAuthModal.input.value.trim();
                if (!authId) { allElements.reportAuthModal.error.textContent = 'å¯†ç¢¼ä¸èƒ½ç‚ºç©ºã€‚'; return; }
                const employee = employees.find(emp => emp.card === authId || emp.password === authId);
                // Admin can also access reports with their password
                if (authId === adminPassword || employee) { openReportPanel(authId); } 
                else { allElements.reportAuthModal.error.textContent = 'å¯†ç¢¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚'; }
            });
            allElements.reportAuthModal.cancelBtn.addEventListener('click', () => allElements.reportAuthModal.overlay.classList.remove('show'));
            allElements.reportAuthModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') allElements.reportAuthModal.confirmBtn.click(); });
            allElements.report.generateBtn.addEventListener('click', generateReportData);
            
            allElements.toggleFurnaceBtn.addEventListener('click', () => { allElements.furnaceAuthModal.overlay.classList.add('show'); allElements.furnaceAuthModal.input.focus(); allElements.furnaceAuthModal.error.textContent = ''; });
            allElements.furnaceAuthModal.confirmBtn.addEventListener('click', () => {
                if (allElements.furnaceAuthModal.input.value === furnacePassword) {
                    allElements.furnaceAuthModal.overlay.classList.remove('show'); allElements.furnaceAuthModal.input.value = '';
                    allElements.furnaceModal.overlay.classList.add('show');
                } else { allElements.furnaceAuthModal.error.textContent = 'å¯†ç¢¼éŒ¯èª¤ã€‚'; }
            });
            allElements.furnaceAuthModal.cancelBtn.addEventListener('click', () => allElements.furnaceAuthModal.overlay.classList.remove('show'));
            allElements.furnaceAuthModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') allElements.furnaceAuthModal.confirmBtn.click(); });
            allElements.furnaceModal.closeBtn.addEventListener('click', () => allElements.furnaceModal.overlay.classList.remove('show'));

            allElements.employeeModal.manageBtn.addEventListener('click', openEmployeeModal);
            allElements.employeeModal.closeBtn.addEventListener('click', closeEmployeeModal);
            allElements.employeeModal.exportBtn.addEventListener('click', () => { 
                if (employees.length === 0) { 
                    showMessage('äººå“¡åå†Šæ˜¯ç©ºçš„ã€‚', 'info'); 
                    return; 
                } 
                const headers = 'å·¥è™Ÿ,å§“å,æ€§åˆ¥,åœ‹ç±,éƒ¨é–€,å¡è™Ÿ,æ‰“å¡å¯†ç¢¼'; 
                const rows = employees.map(e => [e.id, e.name, e.gender, e.nationality, e.department, e.card, e.password].map(f => `"${String(f || '').replace(/"/g, '""')}"`).join(',')); 
                exportToCSV([headers, ...rows], `employee_registry.csv`); 
            });
            allElements.employeeModal.listBody.addEventListener('click', (e) => {
                const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id;
                if (target.classList.contains('edit-btn')) {
                    const empToEdit = employees.find(emp => emp.id === id);
                    if (empToEdit) { editingEmployeeId = id; allElements.emp.id.value = empToEdit.id; allElements.emp.id.disabled = true; allElements.emp.name.value = empToEdit.name; allElements.emp.gender.value = empToEdit.gender; allElements.emp.nationality.value = empToEdit.nationality; allElements.emp.dept.value = empToEdit.department; allElements.emp.card.value = empToEdit.card; allElements.emp.password.value = empToEdit.password; closeEmployeeModal(); showMessage(`æ­£åœ¨ç·¨è¼¯ ${empToEdit.name} çš„è³‡æ–™ã€‚`, 'info'); }
                } else if (target.classList.contains('delete-btn')) {
                    const empToDelete = employees.find(emp => emp.id === id);
                    if(empToDelete) { showGenericConfirm(`ç¢ºèªåˆªé™¤`, `ç¢ºå®šè¦åˆªé™¤å“¡å·¥ ${empToDelete.name} (å·¥è™Ÿ: ${id}) çš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => { employees = employees.filter(emp => emp.id !== id); saveData('employees_v2', employees); renderEmployeeList(); showMessage('å“¡å·¥è³‡æ–™å·²åˆªé™¤ã€‚', 'info'); }); }
                }
            });

            allElements.confirmGenericModal.confirmBtn.addEventListener('click', () => { if (typeof genericConfirmCallback === 'function') { genericConfirmCallback(); } allElements.confirmGenericModal.overlay.classList.remove('show'); genericConfirmCallback = null; });
            allElements.confirmGenericModal.cancelBtn.addEventListener('click', () => { allElements.confirmGenericModal.overlay.classList.remove('show'); genericConfirmCallback = null; });
            
            allElements.clearRecords.clearBtn.addEventListener('click', handleClearRecords);
            
            allElements.clearRecords.exportAllBtn.addEventListener('click', () => { if (punchRecords.length === 0) { showMessage('æª”æ¡ˆåº«æ˜¯ç©ºçš„ã€‚', 'info'); return; } const sortedRecords = [...punchRecords].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); let csv = ['å·¥è™Ÿ,å§“å,æ‰“å¡æ—¥æœŸ,æ‰“å¡æ™‚é–“,ç­åˆ¥(æ™‚æ®µ),ç‹€æ…‹']; sortedRecords.forEach(r => { const d = new Date(r.timestamp); const s = {'in': 'ä¸Šç­', 'out': 'ä¸‹ç­', 'duplicate': 'é‡è¤‡æ‰“å¡'}[r.type] || 'æœªçŸ¥'; csv.push([r.employeeId, r.name, d.toLocaleDateString('zh-TW'), d.toLocaleTimeString('zh-TW', {hour12: false}), r.shift, s].map(f => `"${String(f || '').replace(/"/g, '""')}"`).join(',')); }); exportToCSV(csv, `all_punch_records_archive.csv`); showMessage('æ‰€æœ‰æ‰“å¡ç´€éŒ„çš„å®Œæ•´æª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼', 'success'); });
            
            document.body.addEventListener('click', bell_initAudio, { once: true });
            
            allElements.punchInput.addEventListener('input', () => {
                if (punchInputTimeout) clearTimeout(punchInputTimeout);
                if (allElements.punchInput.value.trim() !== '') {
                    punchInputTimeout = setTimeout(() => {
                        allElements.punchInput.value = '';
                        allElements.punchStatusSelector.value = 'auto';
                        showMessage('è¼¸å…¥å€å·²æ¸…ç©ºã€‚', 'info');
                    }, 10000);
                }
            });
            allElements.punchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handlePunch(e.target.value); });

            allElements.emp.addBtn.addEventListener('click', handleEmployeeFormSubmit);
            allElements.emp.importCsv.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { loadEmployeesFromCSV(file); } });
            
            // Manual Punch Auth
            allElements.manual.punchBtn.addEventListener('click', () => {
                allElements.manualPunchAuthModal.overlay.classList.add('show');
                allElements.manualPunchAuthModal.input.focus();
                allElements.manualPunchAuthModal.error.textContent = '';
            });
            allElements.manualPunchAuthModal.confirmBtn.addEventListener('click', () => {
                if (allElements.manualPunchAuthModal.input.value === MANUAL_PUNCH_PASSWORD) {
                    allElements.manualPunchAuthModal.overlay.classList.remove('show');
                    allElements.manualPunchAuthModal.input.value = '';
                    executeManualPunch();
                } else {
                    allElements.manualPunchAuthModal.error.textContent = 'é©—è­‰å¯†ç¢¼éŒ¯èª¤ã€‚';
                }
            });
            allElements.manualPunchAuthModal.cancelBtn.addEventListener('click', () => allElements.manualPunchAuthModal.overlay.classList.remove('show'));
            allElements.manualPunchAuthModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') allElements.manualPunchAuthModal.confirmBtn.click(); });


            allElements.report.exportBtn.addEventListener('click', () => {
                const tableBody = allElements.report.tableBody.innerHTML; if (!tableBody || tableBody.includes('æ²’æœ‰ä»»ä½•æ‰“å¡ç´€éŒ„')) { showMessage('æ²’æœ‰å¯åŒ¯å‡ºçš„å ±è¡¨è³‡æ–™ã€‚', 'info'); return; }
                const rows = Array.from(allElements.report.tableBody.rows).map(row => Array.from(row.cells).map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(','));
                const headers = Array.from(allElements.report.tableHead.rows[0].cells).map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(',');
                const startDateStr = allElements.report.startDate.value; const endDateStr = allElements.report.endDate.value;
                exportToCSV([headers, ...rows], `report_${startDateStr}_to_${endDateStr}.csv`);
            });
            
            allElements.bell.historyBtn.addEventListener('click', bell_openHistoryModal);
            allElements.bell.closeHistoryBtn.addEventListener('click', bell_closeHistoryModal);
            allElements.bell.clearHistoryBtn.addEventListener('click', () => {
                if (bell_alarmHistory.length > 0) {
                    showGenericConfirm('æ¸…é™¤æ­·å²ç´€éŒ„', 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŸ¿éˆ´æ­·å²ç´€éŒ„å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸå–”ï¼', () => {
                        bell_alarmHistory = [];
                        saveData('bell_history_v3', bell_alarmHistory);
                        bell_renderHistory();
                        showMessage('éŸ¿éˆ´æ­·å²å·²æ¸…ç©ºã€‚', 'info');
                    });
                } else {
                    showMessage('æ­·å²ç´€éŒ„æœ¬ä¾†å°±æ˜¯ç©ºçš„å–”ï¼', 'info');
                }
            });
            
            allElements.bell.form.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const id = allElements.bell.scheduleId.value; 
                const newData = { 
                    title: allElements.bell.title.value, 
                    time: allElements.bell.time.value, 
                    days: Array.from(allElements.bell.daysContainer.querySelectorAll('input:checked')).map(el => Number(el.value)), 
                    sound: allElements.bell.soundSelect.value, 
                    duration: Number(allElements.bell.durationInput.value)
                }; 
                if (id) { 
                    const i = bell_schedules.findIndex(s => s.id == id); 
                    if(i !== -1) { bell_schedules[i] = { ...bell_schedules[i], ...newData, id: Number(id) }; } 
                } else { 
                    newData.id = Date.now(); 
                    bell_schedules.push(newData); 
                } 
                saveData('bell_schedules_v4', bell_schedules); 
                bell_renderSchedules(); 
                bell_closeModal(); 
                showMessage('éŸ¿éˆ´è¨­å®šå·²å„²å­˜ï¼', 'success'); 
            });

            allElements.bell.scheduleList.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (!btn) return; const item = btn.closest('[data-id]'); if (!item) return; const id = Number(item.dataset.id); if (btn.classList.contains('bell-edit-btn')) { const s = bell_schedules.find(s => s.id === id); if (s) bell_openModal(s); } else if (btn.classList.contains('bell-delete-btn')) { bell_schedules = bell_schedules.filter(s => s.id !== id); saveData('bell_schedules_v4', bell_schedules); bell_renderSchedules(); showMessage('ä¸€å€‹éŸ¿éˆ´å ´æ™¯è¢«ç§»é™¤äº†ã€‚', 'info'); } });
            allElements.bell.addBtn.addEventListener('click', () => bell_openModal());
            allElements.bell.cancelBtn.addEventListener('click', bell_closeModal);
            
            // Sound Manager Listeners
            allElements.soundManager.manageBtn.addEventListener('click', openSoundManager);
            allElements.soundManager.closeBtn.addEventListener('click', closeSoundManager);
            allElements.soundManager.uploadInput.addEventListener('change', handleSoundUpload);
            allElements.soundManager.list.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.sound-delete-btn');
                if (deleteBtn) {
                    handleDeleteSound(deleteBtn.dataset.id);
                }
            });
            
            // Password Change Listeners
            allElements.passwordModal.changeBtn.addEventListener('click', () => openChangePasswordModal('admin'));
            allElements.furnaceAuthModal.changeBtn.addEventListener('click', () => openChangePasswordModal('furnace'));
            allElements.changePasswordModal.confirmBtn.addEventListener('click', handleChangePassword);
            allElements.changePasswordModal.cancelBtn.addEventListener('click', closeChangePasswordModal);

            // Auto Task Listeners
            allElements.autoTask.cycle.addEventListener('change', (e) => {
                const isWeekly = e.target.value === 'weekly';
                allElements.autoTask.dayWeeklyContainer.classList.toggle('hidden', !isWeekly);
                allElements.autoTask.dayMonthlyContainer.classList.toggle('hidden', isWeekly);
            });
            allElements.autoTask.name.addEventListener('change', (e) => {
                allElements.autoTask.deleteWarning.classList.toggle('hidden', e.target.value !== 'delete');
            });
            allElements.autoTask.addBtn.addEventListener('click', handleAddTask);
            allElements.autoTask.list.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-auto-task-btn');
                if (deleteBtn) {
                    const taskId = deleteBtn.dataset.id;
                    autoTasks = autoTasks.filter(t => t.id !== taskId);
                    saveData('auto_tasks_v1', autoTasks);
                    renderAutoTasks();
                    showMessage('è‡ªå‹•ä»»å‹™å·²åˆªé™¤ã€‚', 'info');
                }
            });


            document.body.addEventListener('keydown', handleGlobalKeyPress);
        };

        const initializeSystem = () => {
            employees = loadData('employees_v2', []);
            punchRecords = loadData('punch_records_v2', []);
            const defaultShifts = Array(6).fill().map((_, i) => ({ name: ``, start: '', end: '' }));
            defaultShifts[0] = { name: 'æ—©ç­', start: '09:00', end: '18:00' };
            shifts = loadData('shifts_v2', defaultShifts);
            bell_schedules = loadData('bell_schedules_v4', []);
            bell_alarmHistory = loadData('bell_history_v3', []);
            customSounds = loadData('custom_sounds_v2', []);
            adminPassword = loadData('admin_password_v1', 'TC5128');
            furnacePassword = loadData('furnace_password_v1', 'TC5128');
            autoTasks = loadData('auto_tasks_v1', []);
            taskLog = loadData('task_log_v1', []);
            lastLogResetTimestamp = loadData('last_log_reset_v1', Date.now());

            updateClock(); setInterval(updateClock, 1000);
            renderShiftSettings(); populateShiftSelector(); bell_renderSchedules(); initializeEventListeners();
            renderAutoTasks();
            renderTaskLog();
            
            const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            allElements.report.startDate.value = firstDayOfMonth.toISOString().split('T')[0];
            allElements.report.endDate.value = today.toISOString().split('T')[0];
            allElements.punchInput.focus(); showMessage('éœ‡æ¬£AIä½œæ¯ç³»çµ±å·²æº–å‚™å°±ç·’ã€‚', 'info');
        };
        initializeSystem();
    });
    </script>
</body>
</html>
